---
title: "Autocatalytic cycle stability analysis"
#author: "Uri Barenholz"
date: "19/07/2015"
output: html_document
runtime: shiny
---

We analyze the simple auto-catalytic cycle depicted below.

![A simple auto-catalytic cycle](cycle4.png)

Our analysis focuses on the concentration of the metabolite $C_1$, if it is at a steady state, and if the steady state is stable.
We note that $f_i$ and $f_a$ increase the concentration of $C_1$, and $f_b$ decreases it.

The following plot shows $f_a$ and $f_b$ as a function of $K_{m,a}$,$K_{m,b}$,$V_{max,a}$, $V_{max,b}$, and $f_i$ as a pre-set parameter.
As $f_a+f_i$ represents the flux into $C_1$ and $f_b$ the flux out of $C_1$, any intersection between these two lines is a steady state point.

The stability of the steady state point is determined by the dynamics around it.
For $C=C_{st.st}+\Delta C$, if $f_b(C)>f_a(C)+f_i(C)$, then the excess metabolite will be drained out of the cycle and the steady state point is stable.
If $f_b(C)<f_a(C)+f_i(C)$ then excess metabolite will feed back into the auto-catalytic cycle further increasing $C_1$, making the steady-state point unstable.

```{r, echo=FALSE,message = FALSE}
library(ggplot2)
library(reshape2)
library(fields)

inputPanel(
  sliderInput("fi", label = "$$f_i$$",
              min = 0, max = 1, value = 0.1, step = 0.1),
  sliderInput("Kma", label = "$$K_{m,a}$$",
              min = 0.1, max = 2, value = 1, step = 0.1),
  sliderInput("Kmb", label = "$$K_{m,b}$$",
              min = 0.1, max = 2, value = 2, step = 0.1),
  sliderInput("Va", label = "$$V_{max,a}$$",
              min = 0.1, max = 2, value = 1, step = 0.1),
  sliderInput("Vb", label = "$$V_{max,b}$$",
              min = 0.1, max = 2, value = 1.5, step = 0.1)
)

renderPlot({
  xs <- seq(0,10,0.1)
  fi <- input$fi
  fa <- input$Va*xs/(xs+input$Kma)
  fb <- input$Vb*xs/(xs+input$Kmb)
  data <- data.frame(xs = xs, fb = fb, fa = fa, fin = fa+fi)
  data <- melt(data,id=c("xs"))
  size = element_text(size=18)
  ssize = element_text(size=12)
  ggplot(data = data,aes(x=xs,y=value,colour=variable)) + geom_line() +
    xlab("[C]")+scale_y_continuous(limits=c(0,2))+ylab("flux")+
    scale_color_manual(name="Fluxes",values = c("red","green","cyan"),labels=c(expression(f[b]),
                                                                               expression(f[a]),
                                                                               expression(f[a]+f[i])))+
    guides(colour= guide_legend())+theme(legend.text=size,legend.title=size,axis.text=ssize,axis.title=size)
})

```

Next we want to investigate the fitness landscape produced by this cycle in the experimental setup of a chemostat.
Such a setup implies a constant growth rate, $g$, which is reflected in our system by a constant biomass flux, $f_b=g$.
The fitness in such a setup is determined by the concentration of the feeding metabolite, $X$, at which the pre-set growth rate is sustained.
The lower the concentration of $X$ at which a strain can grow at rate $g$, the higher the fitness of that strain.
To illustrate, if two strains, $S_1$ and $S_2$, are both able to grow at rate $g$, but $S_1$ sustains this rate at an outside metabolite concentration $X_1<X_2$, then it follows that at $X_2$, $S_1$ will grow at a faster rate than $S_2$ and will thus out-compete it in the chemostat.

We therefore replace the input flux, $f_i$, with the affinity of the transporter of $X$, $K_{m,i}$.
We assume membrane economics remain constant, as well as the catalytic rate of the transporter, and thus $V_{max,i}$ does not change during the evolution.

For simplicity, we set the units of measurement of flux and concentration in the system to be such that $K_{m,a}=1$ and $V_{max,a}=1$.
We note that this implies that fluxes and concentrations of the other parameters in the system are now measured relative to $K_{m,a}$ and $V_{max,a}$.

The following plot shows the fitness landscape as a function of $K_{m,i}$ and $K_{m,b}$.
For the growth rate, $g$, we pick an initial value of $1/2 < V_{max,a}$ to reflect the fact that semi-autotrophic strains can maintain growth in the chemostat even with no supplied carbon source $X$.
The maximum transporter capacity is set to $V_{max,i}=1.5$ reflecting the fact that at high-enough external metabolite concentration, the growth rate can be higher than the one dictated by the chemostat, as well as the one allowed by the auto-catalytic cycle alone.
Initially, $V_{max,b}=2>V_{max,i}$, implying that even at high concentration of the external metabolite, the biomass reaction is not saturated, meaning high concentrations of $X$ will not cause the cycle to explode. All of these parameters can be modified below to see their effect on the generated fitness landscape.

We plot the value of $-\log(X)$ to extend the dynamic range and make higher values represent higher fitness.
Non-feasible solutions are painted white.

```{r, echo=FALSE,fig.width = 4, fig.height = 4}
shinyUI(fluidPage(
sidebarLayout(
    sidebarPanel(
      sliderInput("g", label = "$$g$$",
                  min = 0, max = 2, value = 1, step = 0.1),
      sliderInput("vi", label = "$$V_{max,i}$$",
                  min = 0, max = 2, value = 1, step = 0.1),
      sliderInput("vb", label = "$$V_{max,b}$$",
                  min = 0.1, max = 2, value = 1.5, step = 0.1)
    ),
    mainPanel(
        renderPlot({
          matsize = 20
          scale = 10
          g <- input$g
          Vi <- input$vi
          Vb <- input$vb
          Va <- 1
          Kma <- 1
          rc <- matrix(nrow=matsize,ncol=matsize)
          ks = seq(matsize)
          for(ki in ks)
              for(kb in ks) {
                  Kmi <- ki/scale
                  Kmb <- kb/scale
                  c <- g*Kmb/(Vb-g)
                  fa <- c*Va/(c+Kma)
                  fi <- g-fa
                  x <- fi*Kmi/(Vi-fi)
                  if(!is.finite(c)) { rc[ki,kb] <- NaN
                  } else if(c<0) { rc[ki,kb] <- NaN
                  } else if(fi<0) {rc[ki,kb] <- NaN
                  } else if((Vb/(c+Kmb)-Vb*c/((c+Kmb)^2))<(1/(c+1)-1*c/((c+1)^2))) { rc[ki,kb] <- NaN
                  } else rc[ki,kb] <- -log(x)
              }
          par(mar=c(4,6,4,4))
          image.plot(x=ks/scale,y=ks/scale,rc,xlab = expression(K["m,i"]),ylab = expression(K["m,b"]), cex.lab = 1.5)
          title("")
          mtext("-log(X)",side = 3,adj=1.2)
          mtext("Initial",side = 1,line = -2.5,adj = 0.9,cex = 1.5,col="white")
          mtext("Final",side = 3,line = -2,adj = 0.1,cex = 1.5)
          kbthres = Vb
          if(Vb>1) {
              abline(h=Vb)
              text(x = 1,y=Vb+0.05,labels = "Semi-autotrophism threshold",cex = 1.5)
          }
        },width = 600, height = 500))
    )))
```

The preceding analysis shows that, in our simplified model, increasing $K_{m,b}$ may be necessary to achieve autotrophic growth, and that it increases fitness in chemostat conditions.
However, experimental evidence shows that this is not a sufficient condition for autotrophic growth to emerge.
We therefore extend our model to reflect more complexity of the metabolic network.
Our extended model represents the following metabolic network:

![An extended auto-catalytic cycle](cyclewithenergy.png)

In this network we add Pyruvate, $P$, which is essentially unlimited in the media.
Therefore its transport reaction, $f_p$ is assumed to be adjustable up to some large constant value.
Pyruvate is used both as the energy source to power the auto-catalytic flux, $f_a$, and as the source for materials and energy in the biomass reaction $f_b$.

Multiple substrate reactions are modelled using a simple operational extension of the Michaelis Menten equation:
$$ f = \frac{V_\max \Pi_{i=1}^n S_i}{\Pi_{i=1}^n (K_{m,i}+S_i)} $$
Below we plot how, for a given set of kinetic parameters, the solution space of concentrations of $P$ and $C$ that satisfy a given growth rate, $g$ looks.
These concentrations satisfy the following equation:
$$
C=\frac{K_c}{\frac{V_bP}{g(K_p+P)}-1}
$$

Next we plot what the auto-catalytic cycle flux, $f_a$, is for each such solution.
We note that at steady state $f_i = g-f_a$ (and also that $f_p=f_a+g$, though this is irrelevant at this point), so the higher the auto-catalytic flux, the lower the Xylose input flux, implying a lower concentration at which the phenotype can grow at the specified growth rate.

Finally, we plot a heat map that shows, for any combination of kinetic parameters, the minimum input flux of Xylose needed to support the pre-defined growth rate. Areas where the Xylose input flux is 0 represent semi-autotrophic growth.

```{r, echo=FALSE}
vb = 10
maxc = 10
size = element_text(size=18)
ssize = element_text(size=12)

sidebarLayout(
    sidebarPanel(
      sliderInput("kc", label = "$$k_c$$",
                  min = 0, max = 2, value = 1, step = 0.01),
      sliderInput("kp", label = "$$k_p$$",
                  min = 0.1, max = 2, value = 0.5, step = 0.01),
      sliderInput("kap", label = "$$k_{a,p}$$",
                  min = 0.1, max = 2, value = 1, step = 0.01),
      sliderInput("gr", label = "$$g$$",
                  min = 0.1, max = 2, value = 1, step = 0.1)
    ),
    mainPanel(
        renderPlot({
            ps <- seq(0.01,maxc,0.01)
            kc <- input$kc
            kp <- input$kp
            gr <- input$gr
            cs <- kc/(vb*ps/(gr*(kp+ps))-1)

            data <- data.frame(xs = ps, ys = cs)
            ggplot(data = data,aes(x=xs,y=ys)) + geom_line() +
                xlab("[P]")+ylab("[C]")+
                scale_y_continuous(limits=c(0,10))+
                theme(axis.text=ssize,axis.title=size)
        },height = 400),
        renderPlot({
            ps <- seq(0.01,maxc,0.01)
            kc <- input$kc
            kp <- input$kp
            gr <- input$gr
            va <- 3
            kac <- 1
            kap <- input$kap
            cs <- kc/(vb*ps/(gr*(kp+ps))-1)
            ps <- ps[cs>0]
            cs <- cs[cs>0]
            fas <- va*cs*ps/((kac+cs)*(kap+ps))

            data <- data.frame(xs = ps, ys = fas)
            ggplot(data = data,aes(x=xs,y=ys)) + geom_line() +
                xlab("[P]")+ylab(expression(f[a]))+
                scale_y_continuous(limits=c(0,5))+
                theme(axis.text=ssize,axis.title=size)
        },height = 400),
        renderPlot({
            matsize <- 20
            scale <- 10
            ks = seq(matsize)
            ps <- seq(0.01,maxc,0.01)
            kac <- 1
            va <- 3
            gr <- input$gr
            kp <- input$kp
            rc <- matrix(ncol = matsize,nrow = matsize)
            
            for(kcbi in ks)
                for(kapi in ks) {
                    kcb <- kcbi/scale
                    kap <- kapi/scale
                    cs <- kcb/(vb*ps/(gr*(kp+ps))-1)
                    ps <- ps[cs>0]
                    cs <- cs[cs>0]
                    fas <- va*cs*ps/((kac+cs)*(kap+ps))
                    if(max(fas)>=gr) rc[kcbi,kapi] = 0
                    else rc[kcbi,kapi] = gr-max(fas)
                }

            par(mar=c(4,6,4,4))
            image.plot(x=ks/scale,y=ks/scale,rc,xlab = expression(K["bm,c"]),ylab = expression(K["am,p"]), cex.lab = 3)
            title("")
            mtext(expression("f[i]"),side = 3,adj=1.2)
            mtext("Initial",side = 3,line = -2,adj = 0.1,cex = 2)
            mtext("Final",side = 1,line = -2.5,adj = 0.9,cex = 2,col="white")
        },height = 700)
    )
)

```

Next we turn our focus to stability analysis of autotrophic growth in this network.
For simplicity we define: $\alpha \equiv \frac{\partial f_a}{\partial C}$, $\beta \equiv \frac{\partial f_a}{\partial P}$, $\gamma \equiv \frac{\partial f_b}{\partial C}$, $\delta \equiv \frac{\partial f_b}{\partial P}$.
Using these definitions, and noting that in our system:
$$
\begin{aligned}
& \dot C = f_a-f_b \\
& \dot P = f_p-f_a-f_b
\end{aligned}
$$
We can write the Jacobian matrix for the dynamics of the system as:
$$
J=
\begin{pmatrix}
\alpha - \gamma & \beta - \delta \\
-(\alpha+\gamma) & -(\beta+\delta)
\end{pmatrix}
$$
To ensure stability we need to have negative real parts for the eigenvalues of this matrix.

The characteristic polynomial of this matrix is:
$$
\begin{aligned}
&-(\alpha-\gamma-\lambda)(\beta + \delta+\lambda)+(\beta-\delta)(\alpha+\gamma)=0 \Rightarrow\\
&\lambda^2+(\beta+\gamma+\delta-\alpha)\lambda+2\beta\gamma-2\alpha\delta=0 \\
\end{aligned}
$$
When considering an quadratic equation of the form $x^2+bx+c$, then the conditions for two negative real parts of the roots are:
$$
\begin{aligned}
b>0 \\
c>0
\end{aligned}
$$
Which in our case result in requiring that at the steady state point $(C^*,P^*)$:
$$
\begin{aligned}
&\beta+\gamma+\delta>\alpha \\
&\beta\gamma>\alpha\delta
\end{aligned}
$$

To observe whether stability plays a role in allowing semi-autotrophic growth we plot the following heat-map, using the same parameters as in the previous plot, where 0 denotes non-stable points and 1 denotes stable points.
As the values of the steady state points depend on $f_p$, it is now another input parameter.
